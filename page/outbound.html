<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="zh-tw">
	<head>
		<meta charset="utf-8">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.css">
		<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="/css/style.css">
		<script src="/CoreScripts/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="/SubScripts/class_db_io.js"></script>
	</head>
	<body>
		<div class="load_modal"></div>
		<datalist id="part_list" class="normal_font"></datalist>
        <datalist id="serial_list" class="normal_font"></datalist>
		<div id= "outbound_cnt" class="page_container">
			<label for="part_num_in">品號 :</label><input id="part_num_in" class="part_attr input_container part_list_style normal_font" name="part_num_list" list="part_list" onfocus="this.oldvalue = this.value;" onchange="change_btn( this );this.oldvalue = this.value;" />
			<br><label for="part_name_out">品名 :</label>
			<br><textarea id="part_name_out" class="part_attr normal_font" name="part_name" rows="2" cols="50" wrap="hard" disabled="true" ></textarea>
			<br><label for="part_inventory_out">庫存 :</label><input id="part_inventory_out" class="part_attr input_container normal_font" name="part_inventory" type="number" style="width:100px" disabled="true" value="0" />
			<br><label for="part_variable_in">變量 :</label><input id="part_variable_in" class="part_attr input_container normal_font" name="part_varval" type="number" style="width:100px" value="0" min="0" onchange="set_serial_table();" />
            <br><label for="part_method_in">領用方法 :</label><select id="part_method_in" class="part_attr input_container normal_font" name="part_method" style="width:100px" ><option value="5">領出</option><option value="3">賣出</option><option value="4">借出</option></select>
			<br><label for="part_goal_in">目的 :</label>
			<br><textarea id="part_goal_in" class="part_attr normal_font" name="part_goal" rows="5" cols="50" wrap="hard" ></textarea>
			<br><button type="button" class="btn btn-primary btn_field" onclick="outbound_btn()">領用</button>
            <div id= "serial" class="sub_page_container tab_form">
            </div>
		</div>
		<script language="JavaScript">
			var body = $("body");
            const cnt_ref = document.getElementById( "outbound_cnt" );
            const serial_cnt_ref = document.getElementById( "serial" );
            const dbio = new db_io();

			$(document).on({
				ajaxStart: function(){
					body.addClass("loading");
				},
				ajaxStop: function(){ 
					body.removeClass("loading");
				}
			});

			$(document).ready(function(){
				body.addClass("loading");
				var part_list_options = sessionStorage.getItem( "part_options" );
				$("#part_list").empty();
				$("#part_list").append( part_list_options );
				setTimeout(function() { 
					body.removeClass("loading"); 
				}, 1000);
			});

			
			// inbound button click
			function outbound_btn(){
                var part_attr = cnt_ref.getElementsByClassName("part_attr");
                var param = get_doc_part_attr( part_attr );
                let varval = Number( param.varval );
                if( varval == 0 ){
                    return;
                }
                
                if( param.number == "" ){
                    alert( "請填入正確品號" );
                    return;
                }
                
                if( isNaN( Number( param.inventory ) ) || isNaN( varval ) ){
                    alert( "設定數值錯誤" );
                    return;
                }
                
                let td_node = cnt_ref.getElementsByTagName("td");
                let count = td_node.length;
                let sn = "";
                var sn_arr = new Array();
                for(var i=0; i<count; i++){
                    sn = td_node[i].children[0].value;
                    if( isNaN( Number( sn ) ) && sn.trim().length !== 5 ){
                        alert( "請正確選取流水號" );
                        return;
                    }
                    sn_arr[i] = parseInt( sn, 10 );
                }
                var attr = dbio.AddInventoryQuan();
                param.sn_type = $("#part_method_in").val();
                param.state = attr.state;
                param.action = "sub";
                param.serial = JSON.stringify( sn_arr );
                send_to_db( param ).then( function( response ){
                    if ( response !== false ){
                        param.value = param.number;
                        change_btn( param );
                        alert( response );
                    }
                });
			}
            
            // quantity change button response
            function change_btn( currdata ){
                serial_cnt_ref.innerHTML = "";
                $("#serial_list").empty();
                
                var part_attr = cnt_ref.getElementsByClassName("part_attr");
                var numValue = "";
                if( check_part_num( 0, 15, normal_part_number( currdata.value ) ) ){
                    numValue = currdata.value;
                }
                else if( check_part_num( 0, 15, normal_part_number( currdata.oldvalue ) ) ){
                    numValue = currdata.oldvalue;
                }
                else{
                    alert( "Part number has error" );
                    return;
                }
                let attr = dbio.GetSinglePartDetail();
                attr.number = numValue;
                receive_to_db( attr ).then(function(response){
                    for (var i=0; i<part_attr.length; i++){
                        switch( part_attr[i].name ){
                            case "part_name":
                                part_attr[i].value = response.name;
                                break;
                            case "part_varval":
                                part_attr[i].max = response.stock_quantity;
                                part_attr[i].value = 0;
                                break;
                            case "part_inventory":
                                part_attr[i].value = response.stock_quantity;
                                break;
                            default:
                        }
                    }
                    let attr = dbio.GetSNInbound();
                    let param = get_doc_part_attr( part_attr );
                    param.state = attr.state;
                    param.action = "out";
                    receive_to_db( param ).then(function(response){
						if( response === false ){
							return;
						}
                        const count = response.length;
                        let serial_list_options = "";
                        
						for(var i=0; i < count; i++){
                            serial_list_options += '<option value="'+response[i]+'" />';
						}

                        if ( serial_list_options == "" ){
                            serial_list_options += '<option value=none />';
                        }
                        $("#serial_list").append( serial_list_options );
                    });
                });
            }
			
            function set_serial_table(){
                serial_cnt_ref.innerHTML = "";
                var part_attr = cnt_ref.getElementsByClassName( "part_attr" );
                var param = get_doc_part_attr( part_attr );
                const partNum = param.number;
                const partVal = Number( param.varval );
                const partClass = Number( partNum[0] );
                
                if( isFinite( partVal ) === false || isFinite( partClass ) === false ){
                    alert( "輸入數值有誤" );
                    return;
                }
                
                if( partNum == "" || partVal == 0 || partClass<1 || partClass>2 ){
                    return;
                }

                var text_field_node = document.createElement( "div" );
                text_field_node.setAttribute( "class", "text_field" );
                serial_cnt_ref.appendChild( text_field_node );
                
                var table_obj = document.createElement( "table" );
                var tbody_obj = document.createElement( "tbody" );
                table_obj.appendChild( tbody_obj );
                text_field_node.appendChild( table_obj );
                table_obj.border = "1";
                
                var data_str = "";
                var tr_obj;
                for( var i=0; i<partVal; i++ ){
                    if ( i%5 == 0 ){
                        if ( i!= 0 ){
                            tr_obj.innerHTML = data_str;
                            tbody_obj.appendChild( tr_obj );
                        }
                        tr_obj = document.createElement( "tr" );
                        data_str = "<td style='height:35px;text-align:center' >";
                        data_str += '<input class="input_container serial_list_style normal_font" list="serial_list"/>';
                        data_str += "</td>";
                    }
                    else{
                        data_str += "<td style='height:35px;text-align:center' >";
                        data_str += '<input class="input_container serial_list_style normal_font" list="serial_list"/>';
                        data_str += "</td>";
                    }

                }
                tr_obj.innerHTML = data_str;
                tbody_obj.appendChild( tr_obj );
            }
            
            
		</script>
		<script type="text/javascript" src="/SubScripts/db_send.js"></script>
		<script type="text/javascript" src="/SubScripts/db_receive.js"></script>
		<script type="text/javascript" src="/SubScripts/part_number.js"></script>
		<script type="text/javascript" src="/SubScripts/get.js"></script>
	</body>
</html>
