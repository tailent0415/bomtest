<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="zh-tw">
	<head>
		<meta charset="utf-8">
		<meta name="google-signin-client_id" content="65164552845-kt5nqknig8520gtv3o66aqej0t5a2pfp.apps.googleusercontent.com">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta name="description" content="">
		<meta name="author" content="">
		<!-- Bootstrap core CSS -->
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.css">
		<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="/css/style.css">
		<!-- Bootstrap core JavaScript -->
		<script src="/scripts/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/extensions/multiple-search/bootstrap-table-multiple-search.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/locale/bootstrap-table-zh-TW.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/locale/bootstrap-table-zh-TW.min.js"></script>
		<script src="/scripts/bootstrap-table-export.js"></script>
		<script src="/scripts/tableExport.js"></script>
		<script src="/scripts/ga.js"></script>
		<script src="/scripts/class_tab_assign.js"></script>
		
	</head>
	<body>
		<div class="load_modal"></div>
		<div class="login_container">
			<div class="login_icon" id="my-signin2"></div>
			<div class="login_id align_left"><p id="user_title">Guest</p></div>
		</div>
		<datalist id="part_list" class="normal_font"></datalist>
		<datalist id="supplier_list" class="normal_font"></datalist>
		<div class="table_container">
			<ul class="nav nav-tabs">
				<li class="active"><a data-toggle="tab" href="#home">查詢</a></li>
				<li><a data-toggle="tab" href="#menu1">新增料件</a></li>
				<li><a data-toggle="tab" href="#menu2">新增成品/半成品</a></li>
				<li><a data-toggle="tab" href="#menu3">修改</a></li>
				<li><a data-toggle="tab" href="#menu4">入庫&領用</a></li>
				<li><a data-toggle="tab" href="#menu5">BOM</a></li>
				<li><a data-toggle="tab" href="#menu6">紀錄</a></li>
				<li><a data-toggle="tab" href="#menu7">廠商</a></li>
			</ul>
			<div class="tab-content">
				<div id="home" class="tab-pane fade in active">
					<div id="home_toolbar">
						<div class="col-auto">
							<button type="button" class="btn btn-primary" onclick="receive_db_info()" >更新數據</button>
						</div>
					</div>
					<table id="part_table"
						data-toggle="table"
						data-click-to-select="true"
						data-side-pagination="client"
						data-pagination="true"
						data-height="525"
						data-page-list="[5, 10, 50, 100]"
						data-search="true"
						data-id-field="index"
						data-unique-id="index"
						data-show-columns="true"
						data-show-export="true"
						data-row-style="set_table_font"
						data-toolbar="#home_toolbar">
						<thead>
							<tr>
								<th data-field="index">項次</th>
								<th data-field="number" data-formatter="guide_num_format" data-events="guide_event_response">品號</th>
								<th data-field="name">品名</th>
								<th data-field="format">規格</th>
								<th data-field="fignum">圖號</th>
								<th data-field="supplier" data-formatter="guide_supplier_format" data-events="guide_event_response" >廠商</th>
								<th data-field="unit">單位</th>
								<th data-field="stock_quantity">庫存數量</th>
								<th data-field="cost">單位成本</th>
								<th data-field="stock_amount">庫存金額</th>
							</tr>
						</thead>
					</table>					
				</div>
				<div id="menu1" class="tab-pane fade">
					<form class= "tab_form" id="add_part_form">
						<div class="text_field">
							<label for="part_num_in">品號 :</label><input class="numtext input_container normal_font" type=text name="part_num1" size="1" maxlength="1" placeholder="3" style="text-transform:uppercase" onchange="check_part_num(3,1,this.value)">
							<b>－</b><input class="numtext input_container normal_font" type=text name="part_num2" size="2" maxlength="2" placeholder="AA" style="text-transform:uppercase" onchange="check_part_num(2,2,this.value)" >
							<b>－</b><input class="numtext input_container normal_font" type=text name="part_num3" size="3" maxlength="3" placeholder="AAA" style="text-transform:uppercase" onchange="check_part_num(2,3,this.value)" >
							<b>－</b><input class="numtext input_container normal_font" type=text name="part_num4" size="3" maxlength="3" placeholder="AAA" style="text-transform:uppercase" onchange="check_part_num(2,3,this.value)" >
							<b>－</b><input class="numtext input_container normal_font" type=text name="part_num5" size="3" maxlength="3" placeholder="000" style="text-transform:uppercase" onchange="check_part_num(1,3,this.value)" >
							<b>－</b><input class="numtext input_container normal_font" type=text name="part_num6" size="3" maxlength="3" placeholder="000" style="text-transform:uppercase" onchange="check_part_num(1,3,this.value)" >
							<br><label for="part_name_in">品名 :</label>
							<br><textarea id="part_name_in" class="part_attr normal_font" name="part_name" rows="2" cols="50" wrap="hard" ></textarea>
							<br><label for="part_format_in">規格 :</label>
							<br><textarea id="part_format_in" class="part_attr normal_font" name="part_format" rows="2" cols="50" wrap="hard" ></textarea>
							<br><label for="part_fignum_in">圖號 :</label><input id="part_fignum_in" class="part_attr input_container normal_font" name="part_fignum" type="text" style="width:200px" />
							<br><label for="part_supplier_in">廠商 :</label><input id="part_supplier_in" class="part_attr input_container normal_font" name="part_supplier" list="supplier_list" type="text" style="width:100px" onchange="supplier_add_new_name( this.value )" />
							<br><label for="part_unit_in">單位 :</label><select id="part_unit_in" class="part_attr input_container normal_font" name="part_unit" style="width:70px" ><option value="SET">SET</option><option value="PCS">PCS</option></select>
							<br><label for="part_cost_in">成本 :</label><input id="part_cost_in" class="part_attr input_container normal_font" name="part_cost" type="text" style="width:100px" />
						</div>
						<div class="btn_field">
							<button type="button" class="btn btn-primary" onclick="send_new_part()" >新增料件</button>
						</div>
					</form>
				</div>
				<div id="menu2" class="tab-pane fade">
					<div class= "tab_form">
						<form class="text_field" id="add_product_form">
							<label for="part_num_in">品號 :</label><input class="numtext input_container normal_font" type=text name="part_num1" size="1" maxlength="1" placeholder="1" style="text-transform:uppercase" onchange="check_part_num(3,1,this.value)">
							<b>－</b><input class="numtext input_container normal_font" type=text name="part_num2" size="2" maxlength="2" placeholder="AA" style="text-transform:uppercase" onchange="check_part_num(2,2,this.value)" >
							<b>－</b><input class="numtext input_container normal_font" type=text name="part_num3" size="3" maxlength="3" placeholder="AAA" style="text-transform:uppercase" onchange="check_part_num(2,3,this.value)" >
							<b>－</b><input class="numtext input_container normal_font" type=text name="part_num4" size="3" maxlength="3" placeholder="AAA" style="text-transform:uppercase" onchange="check_part_num(2,3,this.value)" >
							<b>－</b><input class="numtext input_container normal_font" type=text name="part_num5" size="3" maxlength="3" placeholder="000" style="text-transform:uppercase" onchange="check_part_num(1,3,this.value)" >
							<b>－</b><input class="numtext input_container normal_font" type=text name="part_num6" size="3" maxlength="3" placeholder="000" style="text-transform:uppercase" onchange="check_part_num(1,3,this.value)" >
							<br><label for="part_name_in">品名 :</label>
							<br><textarea id="part_name_in" class="part_attr normal_font" name="part_name" rows="2" cols="50" wrap="hard" ></textarea>
							<br><label for="part_format_in">規格 :</label>
							<br><textarea id="part_format_in" class="part_attr normal_font" name="part_format" rows="2" cols="50" wrap="hard" ></textarea>
							<br><label for="part_unit_in">單位 :</label><select id="part_unit_in" class="part_attr input_container normal_font" name="part_unit" style="width:70px" ><option value="SET">SET</option><option value="PCS">PCS</option></select>
							<br><label for="part_remark_in">備註 : </label>
							<br><textarea id="part_remark_in" class="part_attr normal_font" name="part_remark" rows="5" cols="50" wrap="hard" ></textarea>
							<br><div id="add_product_toolbar">
								<button type="button" class="btn btn-primary" onclick='append_btn_res()' >新增表單</button>
								<button type="button" class="btn btn-primary" onclick='send_new_product()' >資料上傳</button>
								<br><label for="part_totalcost_out">總成本 :</label><input type=text id="part_totalcost_out" class="part_attr input_container normal_font" style="width:200px;margin-top:15px" name="part_totalcost" disabled="true" value="0" >
							</div>
							<table id="product_table_add"
								data-toggle="table"
								data-side-pagination="client"
								data-pagination="false"
								data-height="525"
								data-id-field="index"
								data-toolbar="#add_product_toolbar"
								data-row-style="set_table_font"
								data-unique-id="index">
								<thead>
									<tr>
										<th data-field="index">項次</th>
										<th data-field="number" data-formatter="edit_partnum">品號</th>
										<th data-field="name">品名</th>
										<th data-field="quantity" data-formatter="edit_quan">數量</th>
										<th data-field="cost">單位成本</th>
										<th data-field="totalcost">成本加總</th>
										<th data-field="supplier">廠商</th>
										<th data-field="format">規格</th>
										<th data-field="delrow" data-formatter="formatter_delbtn">刪除</th>
									</tr>
								</thead>
							</table>
						</form>
					</div>
				</div>
				<div id="menu3" class="tab-pane fade">
					<div id="revise_title" style="display:none">
						<table id="revise_table"
							data-toggle="table"
							data-side-pagination="client"
							data-pagination="false"
							data-visible = "false"
							data-height="525"
							data-row-style="set_table_font"
							data-id-field="index"
							data-unique-id="index" >
							<thead>
								<tr>
									<th data-field="index">項次</th>
									<th data-field="number" data-formatter="edit_partnum">品號</th>
									<th data-field="name">品名</th>
									<th data-field="quantity" data-formatter="edit_quan">數量</th>
									<th data-field="cost">單位成本</th>
									<th data-field="totalcost">成本加總</th>
									<th data-field="supplier">廠商</th>
									<th data-field="format">規格</th>
									<th data-field="delrow" data-formatter="formatter_delbtn">刪除</th>
								</tr>
							</thead>
						</table>
					</div>
				</div>
				<div id="menu4" class="tab-pane fade">
					<div class= "tab_form">
						<div class="text_field">
							<label for="part_num_in">品號 :</label><input id="part_num_in" class="part_attr input_container part_list_style normal_font" name="part_num_list" list="part_list" onfocus="this.oldvalue = this.value;" onchange="quan_change_btn( this );this.oldvalue = this.value;" />
							<br><label for="part_name_out">品名 :</label>
							<br><textarea id="part_name_out" class="part_attr normal_font" name="part_name" rows="2" cols="50" wrap="hard" disabled="true" ></textarea>
							<br><label for="part_inventory_out">庫存 :</label><input id="part_inventory_out" class="part_attr input_container normal_font" name="inventory" type="number" style="width:100px" disabled="true" value="0" />
							<br><label for="part_variable_in">變量 :</label><input id="part_variable_in" class="part_attr input_container normal_font" name="part_varval" type="number" style="width:100px" value="0" />
							<br><label for="part_location_in">位置 :</label><input id="part_location_in" class="part_attr input_container normal_font" name="part_location" type="text" style="width:100px" placeholder="湖口" />
							<br><label for="part_goal_in">目的 : </label>
							<br><textarea id="part_goal_in" class="part_attr normal_font" name="part_goal" rows="5" cols="50" wrap="hard" ></textarea>
							<br><button type="button" class="btn btn-primary btn_field" onclick="send_inventory_quantity('add')">入庫</button>
							<button type="button" class="btn btn-primary btn_field" onclick="send_inventory_quantity('sub')">領用</button>
						</div>
					</div>
				</div>
				<div id="menu5" class="tab-pane fade">
				</div>
				<div id="menu6" class="tab-pane fade">
					<div id="record_toolbar">
						<div class="col-auto">
							<button type="button" class="btn btn-primary" onclick="delete_record()" >刪除</button>
							<button type="button" class="btn btn-primary" onclick="receive_record()" >更新數據</button>
						</div>
					</div>
					<table id="record_table"
						data-toggle="table"
						data-side-pagination="client"
						data-pagination="true"
						data-page-list="[5, 10, 50, 100]"
						data-search="true"
						data-height="525"
						data-id-field="index"
						data-unique-id="index"
						data-show-columns="true"
						data-toolbar="#record_toolbar"
						data-row-style="set_table_font"
						data-page-number="1">
						<thead>
							<tr>
								<th data-field="state" data-checkbox="true"></th>
								<th data-field="index">項次</th>
								<th data-field="timestamp">時間</th>
								<th data-field="number">品號</th>
								<th data-field="name">品名</th>
								<th data-field="action">行為</th>
								<th data-field="quantity">數量</th>
								<th data-field="goal">目的</th>
								<th data-field="location">位置</th>
							</tr>
						</thead>
					</table>
				</div>
				<div id="menu7" class="tab-pane fade">
					<div class="btn_field">
						<div class="col-auto">
							<button type="button" class="btn btn-primary" onclick="supplier_search_btn()" >查詢頁面</button>
							<button type="button" class="btn btn-primary" onclick="supplier_revise_btn()" >修改頁面</button>
						</div>
					</div>
					<div id="supplier_search_page">
						<div id="supplier_toolbar">
							<button type="button" class="btn btn-primary" onclick="supplier_delete_btn()" >刪除</button>
						</div>
						<table id="supplier_table"
							data-toggle="table"
							data-side-pagination="client"
							data-pagination="true"
							data-page-list="[5, 10, 50, 100]"
							data-search="true"
							data-height="525"
							data-id-field="index"
							data-unique-id="index"
							data-show-columns="true"
							data-toolbar="#supplier_toolbar"
							data-row-style="set_table_font"
							data-page-number="1">
							<thead>
								<tr>
									<th data-field="state" data-checkbox="true"></th>
									<th data-field="index">項次</th>
									<th data-field="supplier">廠商名稱</th>
									<th data-field="contact">聯絡人</th>
									<th data-field="phone">電話</th>
									<th data-field="address">地址</th>
									<th data-field="url">網址</th>
								</tr>
							</thead>
						</table>
					</div>
					<div id="supplier_revise_page">
						<div class= "tab_form">
							<div class="text_field">
								<label for="part_supplier_in">廠商 :</label><input id="part_supplier_in" class="part_attr input_container supplier_list_style normal_font" name="part_supplier" list="supplier_list" onchange="supplier_change_btn( this.value )" />
								<br><label for="part_replace_name_in">廠商名稱更改 :</label><input id="part_replace_name_in" class="part_attr input_container normal_font" name="part_replace_name" type="text" style="width:300px" />
								<br><label for="part_contact_in">聯絡人 :</label><input id="part_contact_in" class="part_attr input_container normal_font" name="part_contact" type="text" style="width:300px" placeholder="Jacky" />
								<br><label for="part_phone_in">電話 :</label><input id="part_phone_in" class="part_attr input_container normal_font" name="part_phone" type="text" style="width:300px" placeholder="(03)598-6199 Ext.5553" />
								<br><label for="part_address_in">地址 :</label><input id="part_address_in" class="part_attr input_container normal_font" name="part_address" type="text" style="width:300px" placeholder="湖口" />
								<br><label for="part_url_in">網址 :</label><input id="part_url_in" class="part_attr input_container normal_font" name="part_url" type="text" style="width:300px" placeholder="http://my.scientech.com.tw/" />
							</div>
						</div>
						<div>
							<button type="button" class="btn btn-primary" onclick="supplier_info_upload()" >上傳</button>
						</div>
					</div>
				</div>
			</div>
		</div>
    <script language="JavaScript">
		var body = $("body");
		var product_table = $("#part_table"); 
		var ele_id;
		var user_id = "";
		var part_list_obj = $("#part_list");
		var part_list_options = "";
		var supplier_list_obj = $("#supplier_list");
		var supplier_list_options = "";
		var tab_page_name = "";
		var bom_node_array = new Array();
		TabProp.SetProp( $("#part_table") );
		
		
		function set_table_font(row, index) {
		  return {
			css: {"font-family": "Monospace, Courier New, sans-serif"}
		  };
		}
		
		
		$(document).on({
			ajaxStart: function() { body.addClass("loading"); },
			ajaxStop: function() { body.removeClass("loading"); }
		});

		$(document).ready(function(){
			// show tab
			$(".nav-tabs a").click(function(){
				$(this).tab('show');
			});
			
			// tab response
		    $('.nav-tabs a').on('shown.bs.tab', function(event){
				tab_page_name = $(event.target).attr('href');   // active tab
				switch( tab_page_name ){
					case "#home":
						product_table = $("#part_table"); 
						ele_id = "home";
						TabProp.SetProp( $("#part_table"), "home" );
						break;
					case "#menu1":
						ele_id = "menu1";
						form_id = "add_part_form"
						break;
					case "#menu2":
						product_table = $("#product_table_add"); 
						ele_id = "menu2";
						form_id = "add_product_form"
						break;
					case "#menu3":
						product_table = $("#revise_table");
						ele_id = "menu3";
						init_revise_interface();
						break;
					case "#menu4":
						ele_id = "menu4";
						break;
					case "#menu5":
						ele_id = "menu5";
						init_bomtable_interface();
						break;
					case "#menu6":
						product_table = $("#record_table");
						ele_id = "menu6";
						TabProp.SetProp( $("#record_table"), "menu6" );
						receive_record();
						break;
					case "#menu7":
						$("#supplier_search_page").show();
						$("#supplier_revise_page").hide();
						product_table = $("#supplier_table");
						ele_id = "menu7";
						receive_supplier_list();
						break;
					default:
				}
			});
		});

		function guide_num_format( val ){
			return ("<a class='guide_part_number' href='javascript:void(0)' >" + val + "</a>");
		}
		
		function guide_supplier_format( val ){
			return ("<a class='guide_part_supplier' href='javascript:void(0)' >" + val + "</a>");
		}
		
		window.guide_event_response = {
			'click .guide_part_number': function (e, value, row, index) {
				chenge_page_to_bom( value );
			},
			'click .guide_part_supplier': function (e, value, row, index) {
				chenge_page_to_supplier( value );
			},
		};
		
		// supplier name link to supplier table
		async function chenge_page_to_supplier( value ) {
			var tab_id_herf = "#menu7";
			var tab_id_name = "menu7";
			var obj = $("#supplier_revise_page");
			$('.nav-tabs a[href="'+ tab_id_herf +'"]').tab('show');
			
			var i = 0;
			while ( tab_page_name !== tab_id_herf && i<20 ){
				await time_delay(200);
				i++
			}
			i = 0;
			while ( obj.is(":hidden") && i<20){
				supplier_revise_btn();
				await time_delay(200);
				i++
			}
			
			cnt = document.getElementById( tab_id_name );
			var_val = cnt.getElementsByClassName("part_attr");
			len_num = var_val.length;
			for (var i=0; i<len_num; i++){
				switch( var_val[i].name ){
					case "part_supplier":
						var_val[i].value = value;
						break;
					default:
						var_val[i].value = "";
				}
			}
			supplier_change_btn( value );
			
		};
		
		// part number link to bom table
		async function chenge_page_to_bom( value ) {
			var tab_id_herf = "#menu5";
			var tab_id_name = "menu5";
			var cnt = document.getElementById( tab_id_name );
			var div_first_obj = document.getElementById( "bom" );
			if( div_first_obj !== null ){
				cnt.removeChild( div_first_obj );
			}
			$('.nav-tabs a[href="'+ tab_id_herf +'"]').tab('show');
			var i = 0;
			while ( tab_page_name !== tab_id_herf && i<20 ){
				await time_delay(200);
				i++
			}
			var len_num = 0;
			var var_val;
			i = 0;
			while ( len_num == 0 && i<20){
				cnt = document.getElementById( tab_id_name );
				var_val = cnt.getElementsByClassName("part_attr");
				len_num = var_val.length;
				await time_delay( 200 );
				i++;
			}
			for (var i=0; i<len_num; i++){
				switch( var_val[i].name ){
					case "part_num_list":
						var_val[i].value = value;
						update_bomtable_type( value, -1 );
						break;
					default:
				}
			}
		};
		
		// time delay
		function time_delay( time_millisecond ) {
			return new Promise(resolve => {
				setTimeout(() => {
					resolve( true );
				}, time_millisecond );
			});
		}

		
		// supplier revise button
		function supplier_revise_btn(){
			$("#supplier_search_page").hide();
			$("#supplier_revise_page").show();
		}
		
		// supplier search button
		function supplier_search_btn(){
			$("#supplier_search_page").show();
			$("#supplier_revise_page").hide();
			receive_supplier_list();
		}
		
		// supplier change name
		function supplier_change_btn( currdata ){
			if( currdata.trim() == "" ){
				return;
			}
			supplier_add_new_name( currdata );
			receive_supplier_info( currdata );
		}
		
		
		// add new supplier name
		function supplier_add_new_name( currdata ){
			if( currdata.trim() == "" ){
				return;
			}
			var attr = {
				"state": "add_supplier_data",
				"supplier": currdata
			};
			send_to_db( attr );
		}
		
		
		// supplier upload information
		function supplier_info_upload(){
			var cnt = document.getElementById( ele_id );
			var part_attr = cnt.getElementsByClassName("part_attr");
			var attr = get_doc_part_attr( part_attr );
			if( attr.supplier == "" ){
				alert( "請輸入廠商名稱" );
				return false;
			}
			var enable_swap = false;
			if ( attr.replace_name.trim() !== "" ){
				enable_swap = true;
			}
			else{
				supplier_add_new_name( attr.supplier );
			}
			attr.state = "replace_supplier";
			send_to_db( attr );

			for (var i=0; i<part_attr.length; i++){
				switch( part_attr[i].name ){
					case "part_supplier":
						if ( enable_swap ){
							part_attr[i].value = attr.replace_name;
						}
						else{
							part_attr[i].value = attr.supplier;
						}
						break;
					case "part_replace_name":
						part_attr[i].value = "";
						break;
					default:
				}
			}
		}
		
		// supplier delete supplier
		function supplier_delete_btn(){
			var sel_target = new Array();
			var del_index = new Array();
			sel_target = product_table.bootstrapTable('getSelections');
			for( var i=0; i<sel_target.length; i++ ){
				del_index[i] = sel_target[i].index
			}
			var json_array = get_json_array( del_index );
			var attr = {
				"state": "rem_supplier_data",
				"del_index": json_array
			};
			send_to_db( attr );
			
		}
		
		
		
		
		// quantity change button response
		function quan_change_btn( currdata ){
			var cnt = document.getElementById( ele_id );
			var partnum = cnt.getElementsByClassName("part_attr");
			var numValue = "";
			if( check_part_num( 0, 15, normal_part_number( currdata.value ) ) ){
				numValue = currdata.value;
			}
			else if( check_part_num( 0, 15, normal_part_number( currdata.oldvalue ) ) ){;
				numValue = currdata.oldvalue;
			}
			partnum[0].value = numValue;
			receive_part_info('quantity', numValue );
		}
		
		
		// addend new row to product table
		function append_btn_res(){
			var data_attr = new Array();
			var data_attr = product_table.bootstrapTable("getData",false);
			product_table.bootstrapTable("append", add_product_part_row(data_attr.length));
			product_table.bootstrapTable("scrollTo", 'bottom');
		};
		
		// add product part table row
		function add_product_part_row( idx ){
			var rows = [];
			
			var num_param ={
				"func": 1,
				"val": "undefined"
			};

			rows.push({
				index: idx,
				number: num_param,
				name: "",
				quantity: "",
				cost: "",
				totalcost: "",
				supplier: "",
				format: "",
				delrow: ""
			});
			return rows;
		}		
		
		
		// remove table row
		function remove_table_row( idx ){
			var attr = product_table.bootstrapTable('getRowByUniqueId', idx );
			var i = 1;
			product_table.bootstrapTable('remove', {
				field: "index",
				values: Array.of(idx)
			});
			
			while( attr !== null ){
				replace_index = idx+i-1;
				product_table.bootstrapTable('updateRow', {
					index: replace_index,
					row: {
						index: replace_index,
					}
				});
				attr = product_table.bootstrapTable('getRowByUniqueId', idx+i+1 );
				i++;
			}
		}


		// table formatter delete button
		function formatter_delbtn( val, row, index ){
			return ("<button class='delbtn btn btn-danger glyphicon glyphicon-remove row-remove' onclick='remove_table_row(" + index + ")'></button>");
		}
		
		
		
		
		// table part quantity sub function
		function edit_quan( param, row, index ){
			if(param.func == 1){
				return ("<p onclick='change_quan_input(" + index + "," + param.val + ")'>" + param.val + "</p>");
			}
			else if(param.func == 2){
				return ("<input type='number' size='3' onblur='update_total_cost(" + index + ",this.value )' value='" + param.val + "'/>");
			}
		}
			
		function change_quan_input( idx, val ){
			if ( isNaN( parseInt( val ) ) ){
				val = 0;
			}
			var quan_param ={
				func: 2,
				val: val
			};
			product_table.bootstrapTable('updateRow', {
				index: idx,
				row: {
					quantity: quan_param
				}
			});
		}

		// calculate total cost and update	
		function update_total_cost( idx, val ){
			var attr = product_table.bootstrapTable('getRowByUniqueId', idx );
			if ( isNaN( parseInt( val ) ) ){
				val = 0;
			}
			
			var quan_param ={
				func: 1,
				val: val
			};
			
			if( typeof attr.cost !== "number"){
				attr.cost = 0;
			}
			
			product_table.bootstrapTable('updateRow', {
				index: idx,
				row: {
					quantity: quan_param,
					totalcost: attr.cost * val,
				}
			});
			data_attr = product_table.bootstrapTable("getData",false);
			var product_cost = 0;
			var value = 0;
			for( var i = 0; i<data_attr.length; i++ ){
				value = parseFloat( data_attr[i].totalcost );
				if( isNaN(value) ){
					value = 0;
				}
				product_cost += value;
			}
			var cnt = document.getElementById( ele_id );
			var part_attr = cnt.getElementsByClassName("part_attr");
			for( var i=0; i<part_attr.length; i++ ){
				if( part_attr[i].name == "part_totalcost" ){
					part_attr[i].value = product_cost;
				}
			}
		}
		
		
		
		// table part number sub function
		function edit_partnum( param, row, index ){
			if(param.func == 1){
				return ("<pre onclick='change_partnum_type_static(" + index + ")'>" + param.val + "</pre>");
			}
			else if(param.func == 2){
				return ("<input list='part_list' id='part_num_input' class='part_list_style normal_font' onblur='change_partnum_type_dynamic(" + index + ",this.value)' value=" + param.val + " ><datalist>" + part_list_options + "</datalist>");
			}
		}
		
		function change_partnum_type_static( idx, source_val ){
			var param = product_table.bootstrapTable( 'getRowByUniqueId', idx );
			if(param.number.val == "undefined"){
				param_val = "";
			}
			else{
				param_val = param.number.val;
			}
			var num_param ={
				func: 2,
				val: param_val
			};
			product_table.bootstrapTable('updateRow', {
				index: idx,
				row: {
					number: num_param
				}
			});
		}
		
		function change_partnum_type_dynamic( idx, source_val ){
			if( check_part_num_noshow( 0, 15, normal_part_number( source_val ) ) ){
				var data = product_table.bootstrapTable( 'getData', false );
				var same_check = true;
				for (var i=0; i<data.length; i++){
					if( i !== idx ){
						if( data[i].number.val == source_val ){
							same_check = false;
							break;
						}
					}
				}
				if(same_check){
					receive_product_param( idx, source_val );
				}
				else{
					alert( "請勿輸入相同品號" );
				}
			}
			var num_param ={
				func: 1,
				val: "undefined"
			};
			var quan_param ={
				func: 1,
				val: 0
			};
			product_table.bootstrapTable('updateRow', {
				index: idx,
				row: {
					index: idx,
					number: num_param,
					name: "",
					quantity: quan_param,
					cost: "",
					supplier: "",
					format: ""
				}
			});
			
		}
		
		
		
		// Init Bomtable interface
		function init_bomtable_interface( ){
			window.bom_node_array = [];
			var cnt = document.getElementById( ele_id );
			var div_first_obj = document.getElementById( "bom" );
			if( div_first_obj !== null ){
				remove_bomtable_interface();
			}
			div_first_obj = document.createElement( "div" );
			div_first_obj.id = "bom"
			div_first_obj.setAttribute("class", "tab_form");
			cnt.appendChild(div_first_obj);
			var div_second_obj = document.createElement( "div" );
			div_second_obj.setAttribute("class", "text_field");
			var data_str = '<label for="part_num_in">品號 : </label><input id="part_num_in" class="part_attr input_container part_list_style normal_font" name="part_num_list" list="part_list" onchange="update_bomtable_type( this.value, -1 )"/>';
			div_second_obj.innerHTML = data_str;
			div_first_obj.appendChild(div_second_obj);
		}

		// Update Bomtable interface type
		function update_bomtable_type( num_value, data_ind ){
			if( check_part_num( 0, 15, normal_part_number( num_value ) ) ){
				if( data_ind == -1 ){
					window.bom_node_array[ window.bom_node_array.length ] = num_value;
					data_ind = window.bom_node_array.length-1;
				};
				
				var attr = {
					"state": "get_single_data",
					"number": num_value,
					"func": "bom_data",
					"index": data_ind
				};
				
				var flag_bool = receive_to_db( attr );
				if( flag_bool == false ){
					init_bomtable_interface();
				}

			}
			else{
				init_bomtable_interface();
			}

		}

		// Remove Bomtable interface
		function remove_bomtable_interface(){
			var cnt = document.getElementById( ele_id );
			var div_obj = document.getElementById( "bom" );
			cnt.removeChild(div_obj);
		}

		// Bomtable Page
		function bomtable_go_page( data_ind ){
			if( data_ind<0 || data_ind>=window.bom_node_array.length ){
				return;
			}
			num_value = window.bom_node_array[ data_ind ];
			update_bomtable_type( num_value, data_ind );
		}

		
		
		// delete select record
		function delete_record(){
			var sel_target = new Array();
			var del_index = new Array();
			sel_target = product_table.bootstrapTable('getSelections');
			for( var i=0; i<sel_target.length; i++ ){
				del_index[i] = sel_target[i].index
			}
			var json_array = get_json_array( del_index );
			var attr = {
				"state": "rem_record_data",
				"del_index": json_array
			};
			send_to_db( attr );
		}
		
		
		
		// revise interface control
		function init_revise_interface(){
			var cnt = document.getElementById( ele_id );
			var div_first_obj = document.getElementById( "revise" );
			if( div_first_obj !== null ){
				remove_revise_interface();
			}
			div_first_obj = document.createElement( "div" );
			div_first_obj.id = "revise";
			div_first_obj.setAttribute("class", "tab_form");
			cnt.appendChild(div_first_obj);
			var div_second_obj = document.createElement( "div" );
			div_second_obj.setAttribute("class", "text_field");
			var data_str = '<label for="part_num_in">品號 : </label><input id="part_num_in" class="input_container part_list_style normal_font" name="part_num_list" list="part_list" onchange="update_revise_type( this.value )"/>';
			div_second_obj.innerHTML = data_str;
			div_first_obj.appendChild(div_second_obj);
		}

		function update_revise_type( num_value ){
			
			if( check_part_num( 0, 15, normal_part_number( num_value ) ) ){
				
				remove_revise_interface();
			
				var revise_table_obj = document.getElementById( "revise_title" );
				var cnt = document.getElementById( ele_id );
				div_first_obj = document.createElement( "div" );
				div_first_obj.id = "revise";
				div_first_obj.setAttribute("class", "tab_form");
				cnt.appendChild(div_first_obj);
											
				var div_second_obj = document.createElement( "div" );
				div_second_obj.setAttribute("class", "text_field");
				div_first_obj.appendChild(div_second_obj);
				
				var data_str = "";
				var table_title = new Array();
				data_str += '<label for="part_num_in">品號 :</label><input id="part_num_in" class="part_attr input_container part_list_style normal_font" name="part_num_list" list="part_list" value="' + num_value + '" onchange="update_revise_type( this.value )"/>';
				data_str += '<br><label for="part_name_in">品名 :</label>';
				data_str += '<br><textarea id="part_name_in" class="part_attr normal_font" name="part_name" rows="2" cols="50" wrap="hard" ></textarea>';
				switch( num_value[0] ){
					case "1":
					case "2":
						data_str += '<br><label for="part_format_in">規格 :</label>';
						data_str += '<br><textarea id="part_format_in" class="part_attr normal_font" name="part_format" rows="2" cols="50" wrap="hard" ></textarea>'
						data_str += '<br><label for="part_unit_in">單位 :</label><select id="part_unit_in" type="text" class="part_attr input_container normal_font" name="part_unit" style="width:70px" ><option value="SET">SET</option><option value="PCS">PCS</option></select>';
						data_str += '<br><label for="part_remark_in">備註 : </label>';
						data_str += '<br><textarea id="part_remark_in" class="part_attr normal_font" name="part_remark" rows="5" cols="50" wrap="hard" ></textarea>';
						data_str += '<br><div class="col-xs-2" style="margin-top:5px;margin-bottom:5px"><button type="button" class="col-xs-12 btn btn-primary" onclick="append_btn_res()" >新增</button></div>';
						data_str += '<div class="col-xs-2" style="margin-top:5px;margin-bottom:5px" ><button type="button" class="col-xs-12 btn btn-primary" onclick="send_revise_product()" >上傳</button></div>';
						data_str += '<div class="col-xs-8 align_right"><label for="part_totalcost_out">總成本 :</label><input type=text id="part_totalcost_out" class="part_attr input_container" style="width:200px;margin-top:15px" name="part_totalcost" disabled="true" value="0"></div>';
						div_second_obj.innerHTML = data_str;
						div_first_obj.appendChild(div_second_obj);
						div_first_obj.after( revise_table_obj );
						revise_table_obj.style.display = "inline";
						receive_part_info( "revise_product_data", num_value )
						break;
					case "3":
					case "4":
						data_str += '<br><label for="part_format_in">規格 :</label>';
						data_str += '<br><textarea id="part_format_in" class="part_attr normal_font" name="part_format" rows="2" cols="50" wrap="hard" ></textarea>'
						data_str += '<br><label for="part_fignum_in">圖號 :</label><input id="part_fignum_in" type="text" class="part_attr input_container normal_font" name="part_fignum" type="text" style="width:200px" />';
						data_str += '<br><label for="part_supplier_in">廠商 :</label><input id="part_supplier_in" type="text" class="part_attr input_container" name="part_supplier" list="supplier_list" type="text" style="width:100px" onchange="supplier_add_new_name( this.value )" />';
						data_str += '<br><label for="part_unit_in">單位 :</label><select id="part_unit_in" type="text" class="part_attr input_container normal_font" name="part_unit" style="width:70px" ><option value="SET">SET</option><option value="PCS">PCS</option></select>';
						data_str += '<br><label for="part_cost_in">成本 :</label><input id="part_cost_in" type="text" class="part_attr input_container normal_font" name="part_cost" type="text" style="width:100px" />';
						data_str += '<br><label for="part_quantity_in">數量 :</label><input id="part_quantity_in" type="text" class="part_attr input_container normal_font" name="part_quantity" type="text" style="width:60px" />';
						data_str += '<div class="btn_field"><button type="button" class="btn btn-primary" onclick="send_revise_part()">修改</button></div>';
						div_second_obj.innerHTML = data_str;
						div_first_obj.appendChild(div_second_obj);
						revise_table_obj.style.display = "none";
						receive_part_info( "revise_part_data", num_value )
						break;
					default:
				}
			}
			else{
				init_revise_interface();
			}
		}

		function remove_revise_interface(){
			var cnt = document.getElementById( ele_id );
			var div_obj = document.getElementById( "revise" );
			document.getElementById( "revise_title" ).style.display = "none";
			cnt.removeChild(div_obj);
		}

		

		// send a new product data to database
		function send_new_product(){
			var cnt = document.getElementById( ele_id );
			var partnum = cnt.getElementsByClassName("numtext");
			var part_attr = cnt.getElementsByClassName("part_attr");
			var num_str = "";
			if( partnum[0].value == "1" || partnum[0].value == "2" ){
				for (i = 0; i < partnum.length; i++) {
					num_str += partnum[i].value;
				}
				send_product_data( part_attr, num_str, "add_newdata" );
			}
			else{
				alert( "input has error" );
			}
			var form_cnt = document.getElementById( form_id );
			form_cnt.reset();
			product_table.bootstrapTable('removeAll');
		}
		
		// send a revise product data to database
		function send_revise_product(){
			var cnt = document.getElementById( ele_id );
			var part_attr = cnt.getElementsByClassName("part_attr");
			var num_str = normal_part_number( part_attr[0].value );
			send_product_data( part_attr, num_str, "replace_data" );
		}
		
		// send product data
		function send_product_data( part_attr, product_num_str, state ){
			if( check_part_num( 0, 15, product_num_str ) ) {
				var attr = get_doc_part_attr( part_attr );
				if (attr !== false){
					var data_str = "";
					var data = product_table.bootstrapTable('getData', false );
					var num_str = "";
					for( var i=0; i<data.length; i++ ){
						num_str = data[i].number.val;
						if( num_str == "undefined" ){
							return;
						}
						data_str += "index=" + i + "&number=" + data[i].number.val + "&quantity=" + data[i].quantity.val + ";";
					}
					attr.state = state;
					attr.number = product_num_str;
					attr.bomcode = data_str;
					send_to_db(attr);
				}
			}
		}
		
		
		
		
		// send a new part data to database
		function send_new_part(){
			var cnt = document.getElementById( ele_id );
			var partnum = cnt.getElementsByClassName("numtext");
			var part_attr = cnt.getElementsByClassName("part_attr");
			var attr;
			var num_str = "";
			if( partnum[0].value == "3" || partnum[0].value == "4" ){
				for (i = 0; i < partnum.length; i++) {
					num_str += partnum[i].value;
				}
				if( check_part_num( 0, 15, num_str ) ) {
					var attr = get_doc_part_attr( part_attr );
					if (attr !== false){
						attr.state = "add_newdata";
						attr.number = num_str;
						send_to_db( attr );
						supplier_add_new_name( attr.supplier );
					}
				}
			}
			else{
				alert( "input has error" );
			}
			var form_cnt = document.getElementById( form_id );
			form_cnt.reset();
		}

		// send replace part data to database
		function send_revise_part(){
			var cnt = document.getElementById( ele_id );
			var part_attr = cnt.getElementsByClassName("part_attr");
			var attr = get_doc_part_attr( part_attr );
			if( attr !== false ){
				attr.number = normal_part_number( attr.number );
				if( check_part_num( 0, 15, attr.number ) ){
					attr.state = "replace_data";
					send_to_db( attr );
					supplier_add_new_name( attr.supplier );
				}
			}
			
		}

		
		
		// send inventory variable to database
		function send_inventory_quantity( source_str ){
			var cnt = document.getElementById( ele_id );
			var part_attr = cnt.getElementsByClassName("part_attr");
			var attr = get_doc_part_attr( part_attr );
			if( attr.number == "" || attr.varval == "" ){
				alert( "input error" );
				return false;
			}
			attr.state = "add_inventory_quantity";
			attr.action = source_str;
			
			send_to_db( attr );
		}

		

		// google login render icon
		function renderButton(){
			gapi.signin2.render('my-signin2', {
				'scope': 'profile email',
				'width': 180,
				'height': 32,
				'longtitle': true,
				'theme': 'dark',
				'onsuccess': onSuccess,
				'onfailure': onFailure
			});
		};

		// google login event
		function onSuccess( googleUser ){
			user_email = googleUser.getBasicProfile().getEmail();
			user_id = user_email.substring( 0, user_email.indexOf("@") );
			user_name = googleUser.getBasicProfile().getName();
			console.log('Logged in as: ' + user_email + user_id );
			document.getElementById("user_title").innerHTML = "Hello"+ " " + user_name;
			receive_db_info();
		};

		// google login failure report
		function onFailure(error){
			alert(JSON.stringify( error ) );
		};
		
		
		
		// receive data for database
		async function receive_to_db( data ){
			data.id = user_id;
			var NewPropRes = TabProp.GetProp();
			try{
				var response = await receive_promise( NewPropRes.tabid, NewPropRes.eleid, data );
				if( response == true ){
					return true;
				}
				else{
					alert( response )
					return false;
				}
			}
			catch(e){
				alert( "資料庫錯誤:" + e  );
				return false;
			}
		}
		
		

		// send data to database
		async function send_to_db(data){
			data.id = user_id;
			try{
				var response = await send_promise(data);
				if( response == true ){
					return true;
				}
				else{
					alert( response )
					return false;
				}
			}
			catch(e){
				alert( "資料庫錯誤:" + e  );
			}
		}
		
    </script>
	
	<script type="text/javascript" src="/scripts/db_receive.js"></script>
	<script type="text/javascript" src="/scripts/db_send.js"></script>
	<script type="text/javascript" src="/scripts/get.js"></script>
	<script type="text/javascript" src="/scripts/part_number.js"></script>
	<script type="text/javascript" src="/scripts/receive.js"></script>
    <script src="https://apis.google.com/js/platform.js?onload=renderButton" async defer></script>
  </body>
</html>