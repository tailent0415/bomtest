<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="zh-tw">
	<head>
		<meta charset="utf-8">
		<meta name="google-signin-client_id" content="65164552845-kt5nqknig8520gtv3o66aqej0t5a2pfp.apps.googleusercontent.com">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta name="description" content="">
		<meta name="author" content="">
		<!-- Bootstrap core CSS -->
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.css">
		<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="/css/style.css">
		<!-- Bootstrap core JavaScript -->
		<script src="/scripts/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/extensions/multiple-search/bootstrap-table-multiple-search.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/locale/bootstrap-table-zh-TW.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/locale/bootstrap-table-zh-TW.min.js"></script>
		<script src="/scripts/bootstrap-table-export.js"></script>
		<script src="/scripts/tableExport.js"></script>
		<script src="/scripts/ga.js"></script>
	</head>
	<body>
		<div class="load_modal"></div>
		<div class="login_container">
			<div class="login_icon" id="my-signin2"></div>
			<div class="login_id align_left"><p id="user_title">Guest</p></div>
		</div>
		<datalist id="part_list" class="normal_font"></datalist>
		<div class="table_container">
			<ul class="nav nav-tabs">
				<li class="active"><a data-toggle="tab" href="#home">查詢</a></li>
				<li><a data-toggle="tab" href="#menu1">新增料件</a></li>
				<li><a data-toggle="tab" href="#menu2">新增成品/半成品</a></li>
				<li><a data-toggle="tab" href="#menu3">修改</a></li>
				<li><a data-toggle="tab" href="#menu4">入庫&領用</a></li>
				<li><a data-toggle="tab" href="#menu5">BOM</a></li>
				<li><a data-toggle="tab" href="#menu6">紀錄</a></li>
			</ul>
			<div class="tab-content">
				<div id="home" class="tab-pane fade in active">
					<div id="home_toolbar">
						<div class="col-auto">
							<button type="button" class="btn btn-primary" onclick="receive_db_info()" >更新數據</button>
						</div>
					</div>
					<table id="part_table"
						data-toggle="table"
						data-click-to-select="true"
						data-side-pagination="client"
						data-pagination="true"
						data-height="525"
						data-page-list="[5, 10, 50, 100]"
						data-search="true"
						data-id-field="index"
						data-unique-id="index"
						data-show-columns="true"
						data-show-export="true"
						data-row-style="set_table_font"
						data-toolbar="#home_toolbar">
						<thead>
							<tr>
								<th data-field="index">項次</th>
								<th data-field="number">品號</th>
								<th data-field="name">品名</th>
								<th data-field="format">規格</th>
								<th data-field="fignum">圖號</th>
								<th data-field="supplier">廠商</th>
								<th data-field="unit">單位</th>
								<th data-field="stock_quantity">庫存數量</th>
								<th data-field="cost">單位成本</th>
								<th data-field="stock_amount">庫存金額</th>
							</tr>
						</thead>
					</table>
				</div>
				<div id="menu1" class="tab-pane fade">
					<form class= "tab_form" id="add_part_form">
						<div class="text_field">
							<label for="part_num_in">品號 :</label><input class="numtext input_container normal_font" type=text name="part_num1" size="1" maxlength="1" placeholder="3" style="text-transform:uppercase" onchange="check_part_num(3,1,this.value)">
							<b>－</b><input class="numtext input_container normal_font" type=text name="part_num2" size="2" maxlength="2" placeholder="AA" style="text-transform:uppercase" onchange="check_part_num(2,2,this.value)" >
							<b>－</b><input class="numtext input_container normal_font" type=text name="part_num3" size="3" maxlength="3" placeholder="AAA" style="text-transform:uppercase" onchange="check_part_num(2,3,this.value)" >
							<b>－</b><input class="numtext input_container normal_font" type=text name="part_num4" size="3" maxlength="3" placeholder="AAA" style="text-transform:uppercase" onchange="check_part_num(2,3,this.value)" >
							<b>－</b><input class="numtext input_container normal_font" type=text name="part_num5" size="3" maxlength="3" placeholder="000" style="text-transform:uppercase" onchange="check_part_num(1,3,this.value)" >
							<b>－</b><input class="numtext input_container normal_font" type=text name="part_num6" size="3" maxlength="3" placeholder="000" style="text-transform:uppercase" onchange="check_part_num(1,3,this.value)" >
							<br><label for="part_name_in">品名 :</label>
							<br><textarea id="part_name_in" class="part_attr normal_font" name="part_name" rows="2" cols="50" wrap="hard" ></textarea>
							<br><label for="part_format_in">規格 :</label>
							<br><textarea id="part_format_in" class="part_attr normal_font" name="part_format" rows="2" cols="50" wrap="hard" ></textarea>
							<br><label for="part_fignum_in">圖號 :</label><input id="part_fignum_in" class="part_attr input_container normal_font" name="part_fignum" type="text" style="width:200px" />
							<br><label for="part_supplier_in">廠商 :</label><input id="part_supplier_in" class="part_attr input_container normal_font" name="part_supplier" type="text" style="width:100px" />
							<br><label for="part_unit_in">單位 :</label><select id="part_unit_in" class="part_attr input_container normal_font" name="part_unit" style="width:70px" ><option value="SET">SET</option><option value="PCS">PCS</option></select>
							<br><label for="part_cost_in">成本 :</label><input id="part_cost_in" class="part_attr input_container normal_font" name="part_cost" type="text" style="width:100px" />
						</div>
						<div class="btn_field">
							<button type="button" class="btn btn-primary" onclick="send_new_part()" >新增</button>
						</div>
					</form>
				</div>
				<div id="menu2" class="tab-pane fade">
					<div class= "tab_form">
						<form class="text_field" id="add_product_form">
							<label for="part_num_in">品號 :</label><input class="numtext input_container normal_font" type=text name="part_num1" size="1" maxlength="1" placeholder="1" style="text-transform:uppercase" onchange="check_part_num(3,1,this.value)">
							<b>－</b><input class="numtext input_container normal_font" type=text name="part_num2" size="2" maxlength="2" placeholder="AA" style="text-transform:uppercase" onchange="check_part_num(2,2,this.value)" >
							<b>－</b><input class="numtext input_container normal_font" type=text name="part_num3" size="3" maxlength="3" placeholder="AAA" style="text-transform:uppercase" onchange="check_part_num(2,3,this.value)" >
							<b>－</b><input class="numtext input_container normal_font" type=text name="part_num4" size="3" maxlength="3" placeholder="AAA" style="text-transform:uppercase" onchange="check_part_num(2,3,this.value)" >
							<b>－</b><input class="numtext input_container normal_font" type=text name="part_num5" size="3" maxlength="3" placeholder="000" style="text-transform:uppercase" onchange="check_part_num(1,3,this.value)" >
							<b>－</b><input class="numtext input_container normal_font" type=text name="part_num6" size="3" maxlength="3" placeholder="000" style="text-transform:uppercase" onchange="check_part_num(1,3,this.value)" >
							<br><label for="part_name_in">品名 :</label>
							<br><textarea id="part_name_in" class="part_attr normal_font" name="part_name" rows="2" cols="50" wrap="hard" ></textarea>
							<br><label for="part_format_in">規格 :</label>
							<br><textarea id="part_format_in" class="part_attr normal_font" name="part_format" rows="2" cols="50" wrap="hard" ></textarea>
							<br><label for="part_fignum_in">圖號 :</label><input id="part_fignum_in" class="part_attr input_container normal_font" name="part_fignum" type="text" style="width:200px" />
							<br><label for="part_supplier_in">廠商 :</label><input id="part_supplier_in" class="part_attr input_container normal_font" name="part_supplier" type="text" style="width:100px" />
							<br><label for="part_unit_in">單位 :</label><select id="part_unit_in" class="part_attr input_container normal_font" name="part_unit" style="width:70px" ><option value="SET">SET</option><option value="PCS">PCS</option></select>
							<br><label for="part_remark_in">備註 : </label>
							<br><textarea id="part_remark_in" class="part_attr normal_font" name="part_remark" rows="5" cols="50" wrap="hard" ></textarea>
							<br><div id="add_product_toolbar">
								<button type="button" class="btn btn-primary" onclick='append_btn_res()' >新增</button>
								<button type="button" class="btn btn-primary" onclick='send_new_product()' >上傳</button>
								<br><label for="part_totalcost_out">總成本 :</label><input type=text id="part_totalcost_out" class="part_attr input_container normal_font" style="width:200px;margin-top:15px" name="part_totalcost" disabled="true" value="0" >
							</div>
							<table id="product_table_add"
								data-toggle="table"
								data-side-pagination="client"
								data-pagination="false"
								data-height="525"
								data-id-field="index"
								data-toolbar="#add_product_toolbar"
								data-row-style="set_table_font"
								data-unique-id="index">
								<thead>
									<tr>
										<th data-field="index">項次</th>
										<th data-field="number" data-formatter="edit_partnum">品號</th>
										<th data-field="name">品名</th>
										<th data-field="quantity" data-formatter="edit_quan">數量</th>
										<th data-field="cost">單位成本</th>
										<th data-field="totalcost">成本加總</th>
										<th data-field="supplier">廠商</th>
										<th data-field="format">規格</th>
										<th data-field="delrow" data-formatter="formatter_delbtn">刪除</th>
									</tr>
								</thead>
							</table>
						</form>
					</div>
				</div>
				<div id="menu3" class="tab-pane fade">
					<div id="revise_title" style="display:none">
						<table id="revise_table"
							data-toggle="table"
							data-side-pagination="client"
							data-pagination="false"
							data-visible = "false"
							data-height="525"
							data-row-style="set_table_font"
							data-id-field="index"
							data-unique-id="index" >
							<thead>
								<tr>
									<th data-field="index">項次</th>
									<th data-field="number" data-formatter="edit_partnum">品號</th>
									<th data-field="name">品名</th>
									<th data-field="quantity" data-formatter="edit_quan">數量</th>
									<th data-field="cost">單位成本</th>
									<th data-field="totalcost">成本加總</th>
									<th data-field="supplier">廠商</th>
									<th data-field="format">規格</th>
									<th data-field="delrow" data-formatter="formatter_delbtn">刪除</th>
								</tr>
							</thead>
						</table>
					</div>
				</div>
				<div id="menu4" class="tab-pane fade">
					<div class= "tab_form">
						<div class="text_field">
							<label for="part_num_in">品號 :</label><input id="part_num_in" class="part_attr input_container part_list_style normal_font" name="part_num_list" list="part_list" onfocus="this.oldvalue = this.value;" onchange="quan_change_btn( this );this.oldvalue = this.value;" />
							<br><label for="part_name_out">品名 :</label>
							<br><textarea id="part_name_out" class="part_attr normal_font" name="part_name" rows="2" cols="50" wrap="hard" disabled="true" ></textarea>
							<br><label for="part_inventory_out">庫存 :</label><input id="part_inventory_out" class="part_attr input_container normal_font" name="inventory" type="number" style="width:100px" disabled="true" value="0" />
							<br><label for="part_variable_in">變量 :</label><input id="part_variable_in" class="part_attr input_container normal_font" name="part_varval" type="number" style="width:100px" value="0" />
							<br><label for="part_location_in">位置 :</label><input id="part_location_in" class="part_attr input_container normal_font" name="part_location" type="text" style="width:100px" placeholder="湖口" />
							<br><label for="part_goal_in">目的 : </label>
							<br><textarea id="part_goal_in" class="part_attr normal_font" name="part_goal" rows="5" cols="50" wrap="hard" ></textarea>
							<br><button type="button" class="btn btn-primary btn_field" onclick="send_inventory_quantity('add')">入庫</button>
							<button type="button" class="btn btn-primary btn_field" onclick="send_inventory_quantity('sub')">領用</button>
						</div>
					</div>
				</div>
				<div id="menu5" class="tab-pane fade">
				</div>
				<div id="menu6" class="tab-pane fade">
					<div id="record_toolbar">
						<div class="col-auto">
							<button type="button" class="btn btn-primary" onclick="delete_record()" >刪除</button>
							<button type="button" class="btn btn-primary" onclick="receive_record()" >更新數據</button>
						</div>
					</div>
					<table id="record_table"
						data-toggle="table"
						data-side-pagination="client"
						data-pagination="true"
						data-page-list="[5, 10, 50, 100]"
						data-search="true"
						data-height="525"
						data-id-field="index"
						data-unique-id="index"
						data-show-columns="true"
						data-toolbar="#record_toolbar"
						data-row-style="set_table_font"
						data-page-number="1">
						<thead>
							<tr>
								<th data-field="state" data-checkbox="true"></th>
								<th data-field="index">項次</th>
								<th data-field="timestamp">時間</th>
								<th data-field="number">品號</th>
								<th data-field="name">品名</th>
								<th data-field="action">行為</th>
								<th data-field="quantity">數量</th>
								<th data-field="goal">目的</th>
								<th data-field="location">位置</th>
							</tr>
						</thead>
					</table>
				</div>
			</div>
		</div>
    <script language="JavaScript">
		var body = $("body");
		var product_table = $("#part_table"); 
		var ele_id;
		var user_id = "";
		var part_list_obj = $("#part_list");
		var part_list_options = "";
		var bom_node_array = new Array();

		
		function set_table_font(row, index) {
		  return {
			css: {"font-family": "Monospace, Courier New, sans-serif"}
		  };
		}
		
		
		$(document).on({
			ajaxStart: function() { body.addClass("loading"); },
			ajaxStop: function() { body.removeClass("loading"); }
		});

		$(document).ready(function(){
			// show tab
			$(".nav-tabs a").click(function(){
				$(this).tab('show');
			});
			
			// tab response
		    $('.nav-tabs a').on('shown.bs.tab', function(event){
				var x = $(event.target).text();   // active tab
				switch(x){
					case "查詢":
						product_table = $("#part_table"); 
						ele_id = "home";
						break;
					case "新增料件":
						ele_id = "menu1";
						form_id = "add_part_form"
						break;
					case "新增成品/半成品":
						product_table = $("#product_table_add"); 
						ele_id = "menu2";
						form_id = "add_product_form"
						break;
					case "修改":
						product_table = $("#revise_table");
						ele_id = "menu3";
						init_revise_interface();
						break;
					case "入庫&領用":
						ele_id = "menu4";
						break;
					case "BOM":
						ele_id = "menu5";
						init_bomtable_interface();
						break;
					case "紀錄":
						product_table = $("#record_table");
						ele_id = "menu6";
						receive_record();
						break;
					default:
				}
			});
		});
		
		// quantity change button response
		function quan_change_btn( currdata ){
			var cnt = document.getElementById( ele_id );
			var partnum = cnt.getElementsByClassName("part_attr");
			var numValue = "";
			if( check_part_num( 0, 15, normal_part_number( currdata.value ) ) ){
				numValue = currdata.value;
			}
			else if( check_part_num( 0, 15, normal_part_number( currdata.oldvalue ) ) ){;
				numValue = currdata.oldvalue;
			}
			partnum[0].value = numValue;
			receive_part_info('quantity', numValue );
		}
		
		
		// addend new row to product table
		function append_btn_res(){
			var data_attr = new Array();
			var data_attr = product_table.bootstrapTable("getData",false);
			product_table.bootstrapTable("append", add_product_part_row(data_attr.length));
			product_table.bootstrapTable("scrollTo", 'bottom');
		};
		
		// add product part table row
		function add_product_part_row( idx ){
			var rows = [];
			
			var num_param ={
				"func": 1,
				"val": "undefined"
			};

			rows.push({
				index: idx,
				number: num_param,
				name: "",
				quantity: "",
				cost: "",
				totalcost: "",
				supplier: "",
				format: "",
				delrow: ""
			});
			return rows;
		}		
		
		
		// remove table row
		function remove_table_row( idx ){
			var attr = product_table.bootstrapTable('getRowByUniqueId', idx );
			var i = 1;
			product_table.bootstrapTable('remove', {
				field: "index",
				values: Array.of(idx)
			});
			
			while( attr !== null ){
				replace_index = idx+i-1;
				product_table.bootstrapTable('updateRow', {
					index: replace_index,
					row: {
						index: replace_index,
					}
				});
				attr = product_table.bootstrapTable('getRowByUniqueId', idx+i+1 );
				i++;
			}
		}


		// table formatter delete button
		function formatter_delbtn( val, row, index ){
			return ("<button class='delbtn btn btn-danger glyphicon glyphicon-remove row-remove' onclick='remove_table_row(" + index + ")'></button>");
		}
		
		
		
		
		// table part quantity sub function
		function edit_quan( param, row, index ){
			if(param.func == 1){
				return ("<p onclick='change_quan_input(" + index + "," + param.val + ")'>" + param.val + "</p>");
			}
			else if(param.func == 2){
				return ("<input type='number' size='3' onblur='update_total_cost(" + index + ",this.value )' value='" + param.val + "'/>");
			}
		}
			
		function change_quan_input( idx, val ){
			if ( isNaN( parseInt( val ) ) ){
				val = 0;
			}
			var quan_param ={
				func: 2,
				val: val
			};
			product_table.bootstrapTable('updateRow', {
				index: idx,
				row: {
					quantity: quan_param
				}
			});
		}

		// calculate total cost and update	
		function update_total_cost( idx, val ){
			var attr = product_table.bootstrapTable('getRowByUniqueId', idx );
			if ( isNaN( parseInt( val ) ) ){
				val = 0;
			}
			
			var quan_param ={
				func: 1,
				val: val
			};
			
			if( typeof attr.cost !== "number"){
				attr.cost = 0;
			}
			
			product_table.bootstrapTable('updateRow', {
				index: idx,
				row: {
					quantity: quan_param,
					totalcost: attr.cost * val,
				}
			});
			data_attr = product_table.bootstrapTable("getData",false);
			var product_cost = 0;
			var value = 0;
			for( var i = 0; i<data_attr.length; i++ ){
				value = parseFloat( data_attr[i].totalcost );
				if( isNaN(value) ){
					value = 0;
				}
				product_cost += value;
			}
			var cnt = document.getElementById( ele_id );
			var part_attr = cnt.getElementsByClassName("part_attr");
			for( var i=0; i<part_attr.length; i++ ){
				if( part_attr[i].name == "part_totalcost" ){
					part_attr[i].value = product_cost;
				}
			}
		}
		
		
		
		// table part number sub function
		function edit_partnum( param, row, index ){
			if(param.func == 1){
				return ("<pre onclick='change_partnum_type_static(" + index + ")'>" + param.val + "</pre>");
			}
			else if(param.func == 2){
				return ("<input list='part_list' id='part_num_input' class='part_list_style normal_font' onblur='change_partnum_type_dynamic(" + index + ",this.value)' value=" + param.val + " ><datalist>" + part_list_options + "</datalist>");
			}
		}
		
		function change_partnum_type_static( idx, source_val ){
			var param = product_table.bootstrapTable( 'getRowByUniqueId', idx );
			if(param.number.val == "undefined"){
				param_val = "";
			}
			else{
				param_val = param.number.val;
			}
			var num_param ={
				func: 2,
				val: param_val
			};
			product_table.bootstrapTable('updateRow', {
				index: idx,
				row: {
					number: num_param
				}
			});
		}
		
		function change_partnum_type_dynamic( idx, source_val ){
			if( check_part_num_noshow( 0, 15, normal_part_number( source_val ) ) ){
				var data = product_table.bootstrapTable( 'getData', false );
				var same_check = true;
				for (var i=0; i<data.length; i++){
					if( i !== idx ){
						if( data[i].number.val == source_val ){
							same_check = false;
							break;
						}
					}
				}
				if(same_check){
					receive_product_param( idx, source_val );
				}
				else{
					alert( "請勿輸入相同品號" );
				}
			}
			var num_param ={
				func: 1,
				val: "undefined"
			};
			var quan_param ={
				func: 1,
				val: 0
			};
			product_table.bootstrapTable('updateRow', {
				index: idx,
				row: {
					index: idx,
					number: num_param,
					name: "",
					quantity: quan_param,
					cost: "",
					supplier: "",
					format: ""
				}
			});
			
		}
		
		
		
		// Init Bomtable interface
		function init_bomtable_interface( ){
			window.bom_node_array = [];
			var cnt = document.getElementById( ele_id );
			var div_first_obj = document.getElementById( "bom" );
			if( div_first_obj !== null ){
				remove_bomtable_interface();
			}
			div_first_obj = document.createElement( "div" );
			div_first_obj.id = "bom"
			div_first_obj.setAttribute("class", "tab_form");
			cnt.appendChild(div_first_obj);
			var div_second_obj = document.createElement( "div" );
			div_second_obj.setAttribute("class", "text_field");
			var data_str = '<label for="part_num_in">品號 : </label><input id="part_num_in" class="input_container part_list_style normal_font" name="part_num_list" list="part_list" onchange="update_bomtable_type( this.value, -1 )"/>';
			div_second_obj.innerHTML = data_str;
			div_first_obj.appendChild(div_second_obj);
		}

		// Update Bomtable interface type
		function update_bomtable_type( num_value, data_ind ){
			if( check_part_num( 0, 15, normal_part_number( num_value ) ) ){
				if( data_ind == -1 ){
					window.bom_node_array[ window.bom_node_array.length ] = num_value;
					data_ind = window.bom_node_array.length-1;
				};
				
				var attr = {
					"state": "get_single_data",
					"number": num_value,
					"func": "bom_data",
					"index": data_ind
				};
				
				var flag_bool = receive_to_db( attr );
				if( flag_bool == false ){
					init_bomtable_interface();
				}

			}
			else{
				init_bomtable_interface();
			}

		}

		// Remove Bomtable interface
		function remove_bomtable_interface(){
			var cnt = document.getElementById( ele_id );
			var div_obj = document.getElementById( "bom" );
			cnt.removeChild(div_obj);
		}

		// Bomtable Page
		function bomtable_go_page( data_ind ){
			if( data_ind<0 || data_ind>=window.bom_node_array.length ){
				return;
			}
			num_value = window.bom_node_array[ data_ind ];
			update_bomtable_type( num_value, data_ind );
		}

		
		
		// delete select record
		function delete_record(){
			var sel_target = new Array();
			var del_index = new Array();
			sel_target = product_table.bootstrapTable('getSelections');
			for( var i=0; i<sel_target.length; i++ ){
				del_index[i] = sel_target[i].index
			}
			var json_array = get_json_array( del_index );
			var attr = {
				"state": "rem_record_data",
				"del_index": json_array
			};
			send_to_db( attr );
		}
		
		
		
		// revise interface control
		function init_revise_interface(){
			var cnt = document.getElementById( ele_id );
			var div_first_obj = document.getElementById( "revise" );
			if( div_first_obj !== null ){
				remove_revise_interface();
			}
			div_first_obj = document.createElement( "div" );
			div_first_obj.id = "revise";
			div_first_obj.setAttribute("class", "tab_form");
			cnt.appendChild(div_first_obj);
			var div_second_obj = document.createElement( "div" );
			div_second_obj.setAttribute("class", "text_field");
			var data_str = '<label for="part_num_in">品號 : </label><input id="part_num_in" class="input_container part_list_style normal_font" name="part_num_list" list="part_list" onchange="update_revise_type( this.value )"/>';
			div_second_obj.innerHTML = data_str;
			div_first_obj.appendChild(div_second_obj);
		}

		function update_revise_type( num_value ){
			
			if( check_part_num( 0, 15, normal_part_number( num_value ) ) ){
				
				remove_revise_interface();
			
				var revise_table_obj = document.getElementById( "revise_title" );
				var cnt = document.getElementById( ele_id );
				div_first_obj = document.createElement( "div" );
				div_first_obj.id = "revise";
				div_first_obj.setAttribute("class", "tab_form");
				cnt.appendChild(div_first_obj);
											
				var div_second_obj = document.createElement( "div" );
				div_second_obj.setAttribute("class", "text_field");
				div_first_obj.appendChild(div_second_obj);
				
				var data_str = "";
				var table_title = new Array();
				data_str += '<label for="part_num_in">品號 :</label><input id="part_num_in" class="part_attr input_container part_list_style normal_font" name="part_num_list" list="part_list" value="' + num_value + '" onchange="update_revise_type( this.value )"/>';
				data_str += '<br><label for="part_name_in">品名 :</label>';
				data_str += '<br><textarea id="part_name_in" class="part_attr normal_font" name="part_name" rows="2" cols="50" wrap="hard" ></textarea>';
				switch( num_value[0] ){
					case "1":
					case "2":
						data_str += '<br><label for="part_remark_in">備註 : </label>';
						data_str += '<br><textarea id="part_remark_in" class="part_attr" name="part_remark" rows="5" cols="50" wrap="hard" ></textarea>';
						data_str += '<br><div class="col-xs-2" style="margin-top:5px;margin-bottom:5px"><button type="button" class="col-xs-12 btn btn-primary" onclick="append_btn_res()" >新增</button></div>';
						data_str += '<div class="col-xs-2" style="margin-top:5px;margin-bottom:5px" ><button type="button" class="col-xs-12 btn btn-primary" onclick="send_revise_product()" >上傳</button></div>';
						data_str += '<div class="col-xs-8 align_right"><label for="part_totalcost_out">總成本 :</label><input type=text id="part_totalcost_out" class="part_attr input_container" style="width:200px;margin-top:15px" name="part_totalcost" disabled="true" value="0"></div>';
						div_second_obj.innerHTML = data_str;
						div_first_obj.appendChild(div_second_obj);
						div_first_obj.after( revise_table_obj );
						revise_table_obj.style.display = "inline";
						receive_part_info( "revise_product_data", num_value )
						break;
					case "3":
						data_str += '<br><label for="part_format_in">規格 :</label>';
						data_str += '<br><textarea id="part_format_in" class="part_attr normal_font" name="part_format" rows="2" cols="50" wrap="hard" ></textarea>'
						data_str += '<br><label for="part_fignum_in">圖號 :</label><input id="part_fignum_in" type="text" class="part_attr input_container normal_font" name="part_fignum" type="text" style="width:200px" />';
						data_str += '<br><label for="part_supplier_in">廠商 :</label><input id="part_supplier_in" type="text" class="part_attr input_container" name="part_supplier" type="text" style="width:100px" />';
						data_str += '<br><label for="part_unit_in">單位 :</label><select id="part_unit_in" type="text" class="part_attr input_container" name="part_unit" style="width:70px" ><option value="SET">SET</option><option value="PCS">PCS</option></select>';
						data_str += '<br><label for="part_cost_in">成本 :</label><input id="part_cost_in" type="text" class="part_attr input_container" name="part_cost" type="text" style="width:100px" />';
						data_str += '<br><label for="part_quantity_in">數量 :</label><input id="part_quantity_in" type="text" class="part_attr input_container" name="part_quantity" type="text" style="width:60px" />';
						data_str += '<div class="btn_field"><button type="button" class="btn btn-primary" onclick="send_revise_part()">修改</button></div>';
						div_second_obj.innerHTML = data_str;
						div_first_obj.appendChild(div_second_obj);
						revise_table_obj.style.display = "none";
						receive_part_info( "revise_part_data", num_value )
						break;
					default:
				}
			}
			else{
				init_revise_interface();
			}
		}

		function remove_revise_interface(){
			var cnt = document.getElementById( ele_id );
			var div_obj = document.getElementById( "revise" );
			document.getElementById( "revise_title" ).style.display = "none";
			cnt.removeChild(div_obj);
		}

		

		// send a new product data to database
		function send_new_product(){
			var cnt = document.getElementById( ele_id );
			var partnum = cnt.getElementsByClassName("numtext");
			var part_attr = cnt.getElementsByClassName("part_attr");
			var num_str = "";
			if( partnum[0].value == "1" || partnum[0].value == "2" ){
				for (i = 0; i < partnum.length; i++) {
					num_str += partnum[i].value;
				}
				send_product_data( part_attr, num_str, "add_newdata" );
			}
			else{
				alert( "input has error" );
			}
			var form_cnt = document.getElementById( form_id );
			form_cnt.reset();
			product_table.bootstrapTable('removeAll');
		}
		
		// send a revise product data to database
		function send_revise_product(){
			var cnt = document.getElementById( ele_id );
			var part_attr = cnt.getElementsByClassName("part_attr");
			var num_str = normal_part_number( part_attr[0].value );
			send_product_data( part_attr, num_str, "replace_data" );
		}
		
		// send product data
		function send_product_data( part_attr, product_num_str, state ){
			if( check_part_num( 0, 15, product_num_str ) ) {
				var attr = get_doc_part_attr( part_attr );
				if (attr !== false){
					var data_str = "";
					var data = product_table.bootstrapTable('getData', false );
					var num_str = "";
					for( var i=0; i<data.length; i++ ){
						num_str = data[i].number.val;
						if( num_str == "undefined" ){
							return;
						}
						data_str += "index=" + i + "&number=" + data[i].number.val + "&quantity=" + data[i].quantity.val + ";";
					}
					attr.state = state;
					attr.number = product_num_str;
					attr.bomcode = data_str;
					if( data_str !== "" ){
						send_to_db(attr);
					}
				}
			}
		}
		
		
		
		
		// send a new part data to database
		function send_new_part(){
			var cnt = document.getElementById( ele_id );
			var partnum = cnt.getElementsByClassName("numtext");
			var part_attr = cnt.getElementsByClassName("part_attr");
			var attr;
			var num_str = "";
			if( partnum[0].value == "3" ){
				for (i = 0; i < partnum.length; i++) {
					num_str += partnum[i].value;
				}
					
				if( check_part_num( 0, 15, num_str ) ) {
					var attr = get_doc_part_attr( part_attr );
					if (attr !== false){
						attr.state = "add_newdata";
						attr.number = num_str;
						send_to_db( attr );
					}
				}
			}
			else{
				alert( "input has error" );
			}
			var form_cnt = document.getElementById( form_id );
			form_cnt.reset();
		}

		// send replace part data to database
		function send_revise_part(){
			var cnt = document.getElementById( ele_id );
			var part_attr = cnt.getElementsByClassName("part_attr");
			var attr = get_doc_part_attr( part_attr );
			if( attr !== false ){
				attr.number = normal_part_number( attr.number );
				if( check_part_num( 0, 15, attr.number ) ){
					attr.state = "replace_data";
					send_to_db( attr );
				}
			}
		}

		
		
		// send inventory variable to database
		function send_inventory_quantity( source_str ){
			var cnt = document.getElementById( ele_id );
			var part_attr = cnt.getElementsByClassName("part_attr");
			var attr = get_doc_part_attr( part_attr );
			if( attr.number == "" || attr.varval == "" ){
				alert( "input error" );
				return false;
			}
			attr.state = "add_inventory_quantity";
			attr.action = source_str;
			
			send_to_db( attr );
		}

		

		// google login render icon
		function renderButton(){
			gapi.signin2.render('my-signin2', {
				'scope': 'profile email',
				'width': 180,
				'height': 32,
				'longtitle': true,
				'theme': 'dark',
				'onsuccess': onSuccess,
				'onfailure': onFailure
			});
		};

		// google login event
		function onSuccess(googleUser){
			user_email = googleUser.getBasicProfile().getEmail();
			user_id = user_email.substring( 0, user_email.indexOf("@") );
			user_name = googleUser.getBasicProfile().getName();
			console.log('Logged in as: ' + user_email + user_id );
			document.getElementById("user_title").innerHTML = "Hello"+ " " + user_name;
			receive_db_info();
		};

		// google login failure report
		function onFailure(error){
			alert(JSON.stringify( error ) );
		};
		
		
		
		// receive data for database
		async function receive_to_db( data ){
			data.id = user_id;
			try{
				var response = await receive_promise( data);
				if( response == true ){
					console.log( "接收完成" );
					return true;
				}
				else{
					alert( response )
					return false;
				}
			}
			catch(e){
				alert( "資料庫錯誤:" + e  );
				return false;
			}
		}
		
		// receive promise
		function receive_promise( data ){
			return new Promise(function (resolve, reject){
				$.ajax({
					type: "post",
					url: "https://script.google.com/macros/s/AKfycbxY1vSL9WnuIAzh9BqHFpBR6_u_g3Erfmf9tbp2iRhNxtCzp2o/exec",
					data: data,
					dataType: "JSON",
					timeout: 10000,
					success: function(response){
						switch( data.state ){
							case "get_all_data":
								product_table.bootstrapTable('destroy').bootstrapTable({
									exportDataType: "all"
								});
							case "get_record_data":
								product_table.bootstrapTable('removeAll');
								product_table.bootstrapTable('load', response);
								product_table.bootstrapTable('selectPage', '1');
								product_table.bootstrapTable('scrollTo', 'top');
								resolve( true );
								break;	
							case "get_all_partnum":
								if( response[0].number == undefined || response.number == "" ){
									return;
								}
								part_list_options = "";
								for(var i=0; i < response.length; i++){
									part_list_options += '<option value="'+response[i].number+'" />';
								}
								part_list_obj.empty();
								part_list_obj.append( part_list_options );
								resolve( true );
								break;
							case "get_single_data":
								if( response.name == undefined || response.name == "" ){
									resolve( "錯誤的檔案" );
									return;
								}
								switch(data.func){
									case "bom_data":

										remove_bomtable_interface();
										
										var cnt = document.getElementById( ele_id );
										div_first_obj = document.createElement( "div" );
										div_first_obj.id = "bom";
										div_first_obj.setAttribute("class", "tab_form");
										cnt.appendChild(div_first_obj);
										
										var div_second_obj = document.createElement( "div" );
										div_second_obj.setAttribute("class", "text_field");
										div_first_obj.appendChild(div_second_obj);
										
										var data_str = "";
										var table_title = new Array();
										data_str += '<label for="part_num_in">品號 :</label><input id="part_num_in" class="input_container part_list_style normal_font" name="part_num_list" list="part_list" value="' + data.number + '" onchange="update_bomtable_type( this.value, -1 )"/>';
										data_str += '<a onclick="bomtable_go_page(' + (data.index-1) + ')"><i class="fa fa-arrow-circle-left fa-2x fa-fw"></i></a>';
										data_str += '<a onclick="bomtable_go_page(' + (data.index+1) + ')"><i class="fa fa-arrow-circle-right fa-2x"></i></a>';
										switch ( data.number[0] ){
											case '1':
												data_str += '<br><label for="part_cost_out">總成本 :</label><input id="part_cost_out" class="input_container normal_font" style="width:100px" disabled="true" value="' + response.cost + '" />';
												data_str += '<br><label for="part_name_out">品名 :</label>';
												data_str += '<br><textarea id="part_name_out" class="part_attr normal_font" name="part_name" rows="2" cols="50" wrap="hard" disabled="true" >' + response.name + '</textarea>';
												data_str += '<br><label for="part_remark_out">備註 : </label><br><textarea id="part_remark_out" class="normal_font" rows="5" cols="50" wrap="hard" disabled="true" />' + response.remark + '</textarea>';
												table_title = [ '料號', '名稱', '成本', '數量', '備註', 'Sunny註解', '庫存' ];
												break;
											case '2':
												data_str += '<br><label for="part_cost_out">總成本 :</label><input id="part_cost_out" class="input_container normal_font" style="width:100px" disabled="true" value="' + response.cost + '" />';
												data_str += '<br><label for="part_name_out">品名 :</label>';
												data_str += '<br><textarea id="part_name_out" class="part_attr normal_font" name="part_name" rows="2" cols="50" wrap="hard" disabled="true" >' + response.name + '</textarea>';
												data_str += '<br><label for="part_remark_out">備註 :</label><br><textarea id="part_remark_out" class="normal_font" rows="5" cols="50" wrap="hard" disabled="true" />' + response.remark + '</textarea>';
												table_title = [ '料號', '名稱', '成本', '數量', '廠商', '規格', '庫存'  ];
												break;
											case '3':
												data_str += '<br><label for="part_name_out">品名 :</label>';
												data_str += '<br><textarea id="part_name_out" class="part_attr normal_font" name="part_name" rows="2" cols="50" wrap="hard" disabled="true" >' + response.name + '</textarea>';
												data_str += '<br><label for="part_format_out">規格 :</label>';
												data_str += '<br><textarea id="part_format_out" class="part_attr normal_font" name="part_format" rows="2" cols="50" wrap="hard" disabled="true">' + response.format + '</textarea>'
												data_str += '<br><label for="part_supplier_out">廠商 :</label><input id="part_supplier_out" class="input_container normal_font" style="width:100px" disabled="true" value="' + response.supplier + '" />';
												data_str += '<br><label for="part_unit_out">單位 :</label><input id="part_unit_out" class="input_container normal_font" style="width:60px" disabled="true" value="' + response.unit + '" />';
												data_str += '<br><label for="part_cost_out">成本 :</label><input id="part_cost_out" class="input_container normal_font" style="width:200px" disabled="true" value="' + response.cost + '" />';
												data_str += '<br><label for="part_fignum_out">圖號 :</label><input id="part_fignum_out" class="input_container normal_font" style="width:200px" disabled="true" value="' + response.fignum + '" />';
												break;
											default:
												resolve( "input error" );
												return;
										}
										data_str += '<br><label for="part_stock_out">庫存 :</label><input id="part_stock_out" class="input_container normal_font" style="width:60px" disabled="true" value="' + response.stock_quantity + '" />';
										div_second_obj.innerHTML = data_str;
										div_first_obj.appendChild(div_second_obj);
										var title_len = table_title.length;
										if( title_len <= 0 ){
											return;
										}
										
										if( response.data == undefined ){
											resolve( "BOM 不存在" );
											return;
										}
										table_obj = document.createElement( "table" );
										thead_obj = document.createElement( "thead" );
										tbody_obj = document.createElement( "tbody" );
										tr_obj = document.createElement( "tr" );
										table_obj.border = "1";
										var title_str = "";
										var style_str = "";
										for( var i=0; i<title_len; i++ ){
											switch( table_title[i] ){
												case '料號':
													style_str = "style='width:170px;text-align:center' ";
													break;
												case '名稱':
													style_str = "style='width:200px;text-align:center' ";
													break;
												case '成本':
													style_str = "style='width:80px;text-align:center' ";
													break;
												case '數量':
													style_str = "style='width:80px;text-align:center' ";
													break;
												case '廠商':
													style_str = "style='width:100px;text-align:center' ";
													break;
												case '規格':
													style_str = "style='width:200px;text-align:center' ";
													break;
												case '庫存':
													style_str = "style='width:80px;text-align:center' ";
													break;
												case '備註':
													style_str = "style='width:200px;text-align:center' ";
													break;
												case 'Sunny註解':
													style_str = "style='width:80px;text-align:center' ";
													break;
												default:
											}
											title_str += "<td " + style_str + ">" + table_title[i] + "</td>";
										}
										tr_obj.innerHTML = title_str;
										thead_obj.appendChild( tr_obj );
										table_obj.appendChild( thead_obj );
										var data_len = response.data.length;
										var data_str = "";
										for( var i=0; i<data_len; i++ ){
											tr_obj = document.createElement( "tr" );
											data_str = "";
											for( var j=0; j<title_len; j++ ){
												switch( table_title[j] ){
													case '料號':
														var number_str = response.data[i].number;
														var hnumber = "<a style='font-family: Monospace, Courier New, sans-serif' onclick = 'update_bomtable_type( this.text, -1 )' >" + number_str + "</a>";
														res_str = hnumber;
														break;
													case '名稱':
														res_str = response.data[i].name;
														break;
													case '成本':
														res_str = response.data[i].cost;
														break;
													case '數量':
														res_str = response.data[i].quantity;
														break;
													case '廠商':
														res_str = response.data[i].supplier;
														break;
													case '規格':
														res_str = response.data[i].format;
														break;
													case '庫存':
														res_str = response.data[i].stock_quantity;
														break;
													case '備註':
														res_str = response.data[i].remark;
														break;
													case 'Sunny註解':
														res_str = response.data[i].sunnyremark;
														break;
													default:
												}
												data_str += "<td style='height:35px;text-align:center' >" + res_str + "</td>";
											}
											tr_obj.innerHTML = data_str;
											tbody_obj.appendChild( tr_obj );
										}
										table_obj.appendChild( tbody_obj );
										div_first_obj.appendChild( table_obj );
										resolve( true );
										break;
									case "product":
										if( response.number !== undefined ){
											var num_param ={
												func: 1,
												val: response.number
											};
											var quan_param ={
												func: 1,
												val: 0
											};
											product_table.bootstrapTable('updateRow', {
												index: data.index,
												row: {
													index: data.index,
													number: num_param,
													name: response.name,
													quantity: quan_param,
													cost: response.cost,
													supplier: response.supplier,
													format: response.format
												}
											});
											resolve( true );
										}
										break;
									case "revise_part_data":
										var cnt = document.getElementById( ele_id );
										var var_val = cnt.getElementsByClassName("part_attr");
										for (var i=0; i<var_val.length; i++){
											switch( var_val[i].name ){
												case "part_name":
													var_val[i].value = response.name;
													break;
												case "part_format":
													var_val[i].value = response.format;
													break;
												case "part_fignum":
													var_val[i].value = response.fignum;
													break;
												case "part_supplier":
													var_val[i].value = response.supplier;
													break;
												case "part_unit":
													var_val[i].value = response.unit;
													break;
												case "part_cost":
													var_val[i].value = response.cost;
													break;
												case "part_quantity":
													var_val[i].value = response.stock_quantity;
													break;
												default:
											}
										}
										resolve( true );
										break;
									case "quantity":
										var cnt = document.getElementById( ele_id );
										var var_val = cnt.getElementsByClassName("part_attr");
										for (var i=0; i<var_val.length; i++){
											
											switch( var_val[i].name ){
												case "part_name":
													var_val[i].value = response.name;
													break;
												case "inventory":
													var_val[i].value = response.stock_quantity;
													break;
												default:
											}
										}
										resolve( true );
										break;
									case "product_num_search":
										var cnt = document.getElementById( ele_id );
										var var_val = cnt.getElementsByClassName("part_attr");
										product_table.bootstrapTable('removeAll');
										if(response.data == undefined){
											for (var i=0; i<var_val.length; i++){
												switch( var_val[i].name ){	
													case "part_name":
														var_val[i].value = "";
														break;
													case "part_remark":
														var_val[i].value = "";
														break;
													case "part_totalcost":
														var_val[i].value = "";
														break;
													default:
												}
											}
										}
										else{
											for (var i=0; i<var_val.length; i++){
												switch( var_val[i].name ){	
													case "part_name":
														var_val[i].value = response.name;
														break;
													case "part_remark":
														var_val[i].value = response.remark;
														break;
													case "part_totalcost":
														var_val[i].value = response.cost;
														break;
													default:
												}
											}
											product_table.bootstrapTable('load', response.data);
											product_table.bootstrapTable('selectPage', '1');
											product_table.bootstrapTable('scrollTo', 'top');
											resolve( true );
										}
										break;
									case "revise_product_data":
										var cnt = document.getElementById( ele_id );
										var var_val = cnt.getElementsByClassName("part_attr");
										product_table.bootstrapTable('removeAll');
										if(response.data == undefined){
											for (var i=0; i<var_val.length; i++){
												switch( var_val[i].name ){	
													case "part_name":
														var_val[i].value = "";
														break;
													case "part_remark":
														var_val[i].value = "";
														break;
													case "part_totalcost":
														var_val[i].value = "";
														break;
													default:
												}
											}
										}
										else{
											for( var i=0; i<var_val.length; i++ ){
												switch( var_val[i].name ){	
													case "part_name":
														var_val[i].value = response.name;
														break;
													case "part_remark":
														var_val[i].value = response.remark;
														break;
													case "part_totalcost":
														var_val[i].value = response.cost;
														break;
													default:
												};
											}
											
											var rec_data;
											var new_data = new Array();
											for( var i=0; i<response.data.length; i++ ){
												rec_data = response.data[i];
												var num_param ={
													func: 1,
													val: rec_data.number
												};
												var quan_param ={
													func: 1,
													val: rec_data.quantity
												};
												new_data[i] = {
												  "index": rec_data.index,
												  "number": num_param,
												  "name": rec_data.name,
												  "quantity": quan_param,
												  "cost": rec_data.cost,
												  "totalcost": rec_data.totalcost,
												  "supplier": rec_data.supplier,
												  "format": rec_data.format,
												  "delrow": ""
												};
											}
											product_table.bootstrapTable('load', new_data);
											product_table.bootstrapTable('selectPage', '1');
											product_table.bootstrapTable('scrollTo', 'top');
											resolve( true );
										}
										break;
									default:
										resolve( "undefined function" );
								}
								break;
							default:
								resolve( "undefined function" );
						}
					},
					error: function(err){
						reject( err.status + err.responseText );
					}
				});
			});
		}


		// send data to database
		async function send_to_db(data){
			data.id = user_id;
			try{
				var response = await send_promise(data);
				if( response == true ){
					switch( data.state ){
						case "add_newdata":
							receive_db_partlist();
							break;
						case "add_inventory_quantity":
							var attr = {
								"state": "get_single_data",
								"number": data.number,
								"func": 'quantity'
							};
							receive_to_db(attr);
						case "rem_record_data":
							receive_record();
						default:
					}
				}
				else{
					alert( response );
				}

			}
			catch(e){
				alert( "資料庫錯誤:" + e  );
			}
		}
		
		// send promise
		function send_promise( data ){
			
			return new Promise(function (resolve, reject){
				$.ajax({
					type: "get",
					url: "https://script.google.com/macros/s/AKfycbxY1vSL9WnuIAzh9BqHFpBR6_u_g3Erfmf9tbp2iRhNxtCzp2o/exec",
					data: data,
					dataType: "JSON",
					timeout: 10000,
					success: function (response) {
						switch( data.state ){
							case "add_newdata":
								resolve( response );
								break;
							case "replace_data":
								resolve( response );
								break;
							case "add_inventory_quantity":
								resolve( response );
								break;
							case "add_track_data":
								resolve( response );
								break;
							case "rem_record_data":
								resolve( response );
								break;
							default:
						}
					},
					error: function (err) {
						reject( err.status + err.responseText );
					}
				});
			})			
		}
		
    </script>
	<script type="text/javascript" src="/scripts/get.js"></script>
	<script type="text/javascript" src="/scripts/part_number.js"></script>
	<script type="text/javascript" src="/scripts/receive.js"></script>
    <script src="https://apis.google.com/js/platform.js?onload=renderButton" async defer></script>
  </body>
</html>